name: Deploy on Netlify

# Ev√©nements qui d√©clenchent le workflow : triggers
# Ici le workflow se d√©clanche sur chaque push de la branche main ou sur un d√©clenchement manuel
on:
  push:
    branches:
      - main
  workflow_dispatch:

# On d√©fini des permissions pour autoriser le d√©ploiement sur GitHub Pages
# copi√© coll√© de la doc, obligatoire pour que √ßa marche
permissions:
  contents: read
  pages: write
  id-token: write

# on authorise un seul groupe de jobs √† la fois
concurrency:
  # Le nom du groupe de jobs
  group: "pages"
  # on ne veut pas que les jobs soient annul√©s si un autre est en cours
  cancel-in-progress: false

jobs: 

  build-and-deploy:
    runs-on: ubuntu-latest
    # on pense √† pr√©ciser le working-directory pour que les actions se fassent dans dossier frontend
    defaults:
      run:
        working-directory: frontend

    steps: 
      # on r√©cup√®re le code
      - name: üì• Checkout code
        uses: actions/checkout@v4

      # on installe Node.js
      - name: Install Node.js
        uses: actions/setup-node@v4

      # on installe les d√©pendances
      - name: üì¶ Install dependencies
        run: npm install

      # Autres jobs (tests, biome‚Ä¶)

      # on build notre code
      - name: üèóÔ∏è Build the project
        run: npm run build

      # Install de la CLI netlify en local (dans la doc ils recommandent de ne pas l'installer en global)
      # https://docs.netlify.com/cli/get-started/#installation-in-a-ci-environment
      - name: Install Netlify CLI
        #run: npm install netlify-cli --save-dev
        run: npm install netlify-cli -g

      # Deploy to Netlify
      - name: üöÄ Deploy to Netlify
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
        # on fournit direct le dossier √† deployer et on pr√©cise que c'est pour la prod
        run: netlify deploy --prod --dir=dist --site ${{ secrets.NETLIFY_SITE_ID }}

